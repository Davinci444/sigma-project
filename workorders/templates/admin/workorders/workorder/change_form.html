{% extends "admin/change_form.html" %}

{% load i18n admin_urls static %}

{% block content %}

  {{ block.super }}

  {# Panel de evidencias integrado (solo si existe el objeto) #}
  {% if original %}
  <div class="module aligned" style="margin-top:24px;">
    <h2 style="margin-bottom:8px;">Evidencias del Trabajo</h2>
    <p class="help">Sube evidencias (imagen, video, PDF, etc.) y asócialas a un Trabajo de esta OT. Todo queda aquí mismo.</p>

    <form method="post" enctype="multipart/form-data" style="margin-bottom:16px;">
      {% csrf_token %}
      <fieldset class="module aligned">
        <div class="form-row">
          {{ sigma_quick_evidence_form.task.errors }}
          <label>{{ sigma_quick_evidence_form.task.label }}:</label>
          {{ sigma_quick_evidence_form.task }}
        </div>
        <div class="form-row">
          {{ sigma_quick_evidence_form.file.errors }}
          <label>{{ sigma_quick_evidence_form.file.label }}:</label>
          {{ sigma_quick_evidence_form.file }}
        </div>
        <div class="form-row">
          {{ sigma_quick_evidence_form.description.errors }}
          <label>{{ sigma_quick_evidence_form.description.label }}:</label>
          {{ sigma_quick_evidence_form.description }}
        </div>
      </fieldset>
      <div class="submit-row">
        <button type="submit" class="default" name="_upload_evidence">Cargar evidencia</button>
      </div>
    </form>

    {% if sigma_evidence_groups %}
      {% for group in sigma_evidence_groups %}
        <div class="inline-group" style="margin-top:12px;">
          <h3>
            Trabajo: 
            {% if group.task.subcategory %}
              {{ group.task.subcategory }}
            {% elif group.task.category %}
              {{ group.task.category }}
            {% else %}
              {{ group.task }}
            {% endif %}
          </h3>
          {% if group.evidences %}
            <div class="inline-related">
              <table class="listing" style="width:100%;">
                <thead>
                  <tr>
                    <th>Archivo</th>
                    <th>Descripción</th>
                    <th>Fecha</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for ev in group.evidences %}
                    <tr>
                      <td>
                        {% with name=ev.file.name|lower %}
                          {% if name|endswith:".jpg" or name|endswith:".jpeg" or name|endswith:".png" or name|endswith:".gif" %}
                            <img src="{{ ev.file.url }}" style="max-height:80px;border:1px solid #ccc;" />
                          {% elif name|endswith:".mp4" or name|endswith:".mov" or name|endswith:".avi" or name|endswith:".webm" %}
                            <video src="{{ ev.file.url }}" style="max-height:120px;" controls></video>
                          {% else %}
                            <a href="{{ ev.file.url }}" target="_blank">Descargar</a>
                          {% endif %}
                        {% endwith %}
                      </td>
                      <td>{{ ev.description|default:"—" }}</td>
                      <td>{{ ev.uploaded_at }}</td>
                      <td>
                        <a class="deletelink"
                           href="{% url 'admin:workorders_workorder_delete_evidence' original.pk ev.pk %}"
                           onclick="return confirm('¿Eliminar esta evidencia?');">
                           Eliminar
                        </a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="inline-related">
              <p style="padding:8px;">Sin evidencias aún.</p>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div class="inline-group">
        <p style="padding:8px;">No hay trabajos o evidencias para esta OT.</p>
      </div>
    {% endif %}

  </div>
  {% endif %}

{% endblock %}